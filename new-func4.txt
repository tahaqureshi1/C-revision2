const AR_PLACEHOLDER = 'ÿßÿÆÿ™ÿ± ÿÆŸäÿßÿ±Ÿãÿß';
  const EN_DEFAULT = 'Choose an Option';
  const EN_CANDIDATES = ['Choose an Option','Choose an option','Select an Option','Select',''];

  const getHtmlLang = () => (document.documentElement.getAttribute('lang') || '').toLowerCase();
  const isArabic = () => getHtmlLang().startsWith('ar');

  // Optional: scope to a specific Form widget by CSS ID "form-ar"
  const root = document.getElementById('form-ar') || document;

  const getPicklistButtons = () =>
    root.querySelectorAll(
      '.form-group button.form-control-select[role="combobox"], .form-group button[role="combobox"].form-control-select-secondary'
    );

  const ensureOriginalSaved = (group) => {
    // Save tooltip
    const tooltipDiv = group.querySelector('[data-tooltip-align][title]');
    if (tooltipDiv && !tooltipDiv.dataset.origTitle) {
      tooltipDiv.dataset.origTitle = tooltipDiv.getAttribute('title') || '';
    }
    // Save button text
    const btn = group.querySelector('button[role="combobox"]');
    if (btn) {
      const textEl = btn.querySelector('.form-control-select-text') || btn;
      if (!textEl.dataset.origText) {
        textEl.dataset.origText = (textEl.textContent || '').trim();
      }
    }
  };

  // Translate the dropdown MENU (first disabled/placeholder option) for a given field group
  const translateListboxForGroup = (group) => {
    const menus = document.querySelectorAll('.dropdown-menu, [role="listbox"]');
    menus.forEach((menu) => {
      // only touch visible menus
      const style = window.getComputedStyle(menu);
      if (style.display === 'none' || style.visibility === 'hidden') return;

      const option =
        menu.querySelector('[role="option"][aria-disabled="true"]') ||
        menu.querySelector('.dropdown-item.disabled') ||
        menu.querySelector('[data-value=""], [data-option-value=""], [data-ddm-value=""]');

      if (!option) return;

      const current = (option.textContent || '').trim();
      if (isArabic()) {
        if (EN_CANDIDATES.includes(current)) option.textContent = AR_PLACEHOLDER;
      } else {
        if (current === AR_PLACEHOLDER) option.textContent = EN_DEFAULT;
      }
    });
  };

  const bindOpenHandlersOnce = (btn, group) => {
    if (btn.dataset.i18nBound === '1') return;
    const trigger = () => setTimeout(() => translateListboxForGroup(group), 0);
    btn.addEventListener('click', trigger);
    btn.addEventListener('keydown', (e) => {
      if (['Enter',' ','ArrowDown','ArrowUp'].includes(e.key)) trigger();
    });
    btn.dataset.i18nBound = '1';
  };

  const applyArabicToGroup = (group) => {
    const tooltipDiv = group.querySelector('[data-tooltip-align][title]');
    if (tooltipDiv) tooltipDiv.setAttribute('title', AR_PLACEHOLDER);

    const btn = group.querySelector('button[role="combobox"]');
    if (btn) {
      const textEl = btn.querySelector('.form-control-select-text') || btn;
      const current = (textEl.textContent || '').trim();
      if (EN_CANDIDATES.includes(current) || current === (textEl.dataset.origText || '')) {
        textEl.textContent = AR_PLACEHOLDER;
      }
      bindOpenHandlersOnce(btn, group);
    }
  };

  const applyEnglishToGroup = (group) => {
    const tooltipDiv = group.querySelector('[data-tooltip-align][title]');
    if (tooltipDiv && typeof tooltipDiv.dataset.origTitle !== 'undefined') {
      tooltipDiv.setAttribute('title', tooltipDiv.dataset.origTitle);
    }

    const btn = group.querySelector('button[role="combobox"]');
    if (btn) {
      const textEl = btn.querySelector('.form-control-select-text') || btn;
      const current = (textEl.textContent || '').trim();
      if (current === AR_PLACEHOLDER && typeof textEl.dataset.origText !== 'undefined') {
        textEl.textContent = textEl.dataset.origText || EN_DEFAULT;
      }
      // If a menu is open, restore its first disabled item too
      translateListboxForGroup(group);
    }
  };

  const applyAll = () => {
    getPicklistButtons().forEach((btn) => {
      const group = btn.closest('.form-group');
      if (!group) return;
      ensureOriginalSaved(group);
      if (isArabic()) applyArabicToGroup(group);
      else applyEnglishToGroup(group);
    });
  };

  // Initial apply
  applyAll();

  // Re-apply on SPA navigations
  Liferay.on && Liferay.on('endNavigate', applyAll);

  // Re-apply when fields/menus re-render
  const mo = new MutationObserver(() => {
    applyAll();
    document.querySelectorAll('.form-group').forEach(translateListboxForGroup);
  });
  mo.observe(document.body, { childList: true, subtree: true });

  // üîÅ Detect language changes without reload by watching <html lang="...">
  let lastLang = getHtmlLang();
  const langObserver = new MutationObserver(() => {
    const now = getHtmlLang();
    if (now !== lastLang) {
      lastLang = now;
      applyAll(); // re-apply immediately on language switch
    }
  });
  langObserver.observe(document.documentElement, { attributes: true, attributeFilter: ['lang'] });

  // Cleanup
  fragmentElement.addEventListener('DOMNodeRemoved', function handle(e) {
    if (e.target === fragmentElement) {
      mo.disconnect();
      langObserver.disconnect();
      Liferay.detach && Liferay.detach('endNavigate', applyAll);
      fragmentElement.removeEventListener('DOMNodeRemoved', handle);
    }
  });